rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Profiles collection rules
    match /profiles/{userId} {
      // Users can only read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // Users can only create their own profile
      allow create: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['name', 'lastName', 'email', 'userId', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 100
        && request.resource.data.lastName is string
        && request.resource.data.lastName.size() > 0
        && request.resource.data.lastName.size() <= 100
        && request.resource.data.email is string
        && request.resource.data.email.matches('.*@.*\\..*')
        && request.resource.data.userId == request.auth.uid;

      // Users can only update their own profile (limited fields)
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data.userId == resource.data.userId
        && request.resource.data.email == resource.data.email
        && request.resource.data.createdAt == resource.data.createdAt;

      // Users cannot delete their profile (admin only)
      allow delete: if false;
    }

    // Farms collection rules
    match /farms/{farmId} {
      // Users can only read their own farms
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Users can create farms for themselves
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;

      // Users can update their own farms
      allow update: if request.auth != null
        && resource.data.userId == request.auth.uid;

      // Users cannot delete farms (archive instead)
      allow delete: if false;
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
